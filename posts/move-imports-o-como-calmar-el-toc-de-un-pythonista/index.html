<!DOCTYPE html>
<html prefix="
og: http://ogp.me/ns# article: http://ogp.me/ns/article#
" lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>move-imports, o cómo calmar el TOC de un pythonista | tin_nqn</title>
<link href="../../assets/css/bootstrap.min.css" rel="stylesheet" type="text/css">
<link href="../../assets/css/baguetteBox.min.css" rel="stylesheet" type="text/css">
<link href="../../assets/css/rst.css" rel="stylesheet" type="text/css">
<link href="../../assets/css/code.css" rel="stylesheet" type="text/css">
<link href="../../assets/css/theme.css" rel="stylesheet" type="text/css">
<link href="../../assets/css/custom.css" rel="stylesheet" type="text/css">
<link href="../../assets/css/ipython.min.css" rel="stylesheet" type="text/css">
<link href="../../assets/css/nikola_ipython.css" rel="stylesheet" type="text/css">
<meta name="theme-color" content="#5670d4">
<meta name="generator" content="Nikola (getnikola.com)">
<link rel="alternate" type="application/rss+xml" title="RSS (en)" href="../../en/rss.xml">
<link rel="alternate" type="application/rss+xml" title="RSS (es)" href="../../rss.xml">
<link rel="canonical" href="https://mgaitan.github.io/posts/move-imports-o-como-calmar-el-toc-de-un-pythonista/">
<!--[if lt IE 9]><script src="../../assets/js/html5.js"></script><![endif]--><meta name="author" content="Martín Gaitán">
<link rel="prev" href="../el-mono-salta-entre-las-ramas/" title="El mono salta entre las ramas. El desarrollador también" type="text/html">
<meta property="og:site_name" content="tin_nqn">
<meta property="og:title" content="move-imports, o cómo calmar el TOC de un pythonista">
<meta property="og:url" content="https://mgaitan.github.io/posts/move-imports-o-como-calmar-el-toc-de-un-pythonista/">
<meta property="og:description" content="Una historia de éxito: un grupito pequeño de programadores (o quizas sólo uno)
a pura pasión, café y feedback de sus usuarios mete miles de lineas de código
que logran hacer funcionar un negocio.
Part">
<meta property="og:type" content="article">
<meta property="article:published_time" content="2020-05-12T16:13:41-03:00">
<meta property="article:tag" content="scripts">
<meta name="twitter:card" content="summary">
<meta name="twitter:creator:id" content="40654511">
</head>
<body>
<a href="#content" class="sr-only sr-only-focusable">Ir al contenido principal</a>

<!-- Menubar -->

<nav class="navbar navbar-expand-md static-top mb-4
navbar-light bg-light
"><div class="container">
<!-- This keeps the margins nice -->
        <a class="logo" href="../../">

            <div id="blog-title">
                    tin_nqn
                    <span id="blog-description">&gt;&gt;&gt; me.geek.post()</span>
            </div>
        </a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#bs-navbar" aria-controls="bs-navbar" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse" id="bs-navbar">
            <ul class="navbar-nav mr-auto">
<li class="nav-item">
<a href="../../about/" class="nav-link">Sobre mí</a>
                </li>
<li class="nav-item">
<a href="../../charlas/" class="nav-link">Charlas</a>
                </li>
<li class="nav-item">
<a href="../../archive.html" class="nav-link">Archivos</a>
                </li>
<li class="nav-item">
<a href="../../categories/index.html" class="nav-link">Categorías</a>
                </li>
<li class="nav-item">
<a href="../../rss.xml" class="nav-link">RSS</a>

                
            </li>
</ul>
<ul class="navbar-nav navbar-right">
<li>            </li>
<li class="nav-item"><a href="https://mgaitan.github.io/en/" rel="alternate" hreflang="en" class="nav-link">English</a></li>

                
            </ul>
</div>
<!-- /.navbar-collapse -->
    </div>
<!-- /.container -->
</nav><!-- End of Menubar --><div class="container" id="content" role="main">
    <div class="body-content">
        <!--Body content-->
        
<article class="post-text h-entry hentry postpage" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title" itemprop="headline name"><a href="." class="u-url">move-imports, o cómo calmar el TOC de un pythonista</a></h1>

        <div class="metadata">
            <p class="byline author vcard p-author h-card"><span class="byline-name fn p-name" itemprop="author">
                    Martín Gaitán
            </span></p>
            <p class="dateline">
            <a href="." rel="bookmark">
            <time class="published dt-published" datetime="2020-05-12T16:13:41-03:00" itemprop="datePublished" title="2020-05-12 16:13">2020-05-12 16:13</time></a>
            </p>
                <p class="commentline">            <a href="#disqus_thread" data-disqus-identifier="cache/posts/move-imports-o-como-calmar-el-toc-de-un-pythonista.html">Comentarios</a>


            
        </p>
</div>
        
    </header><div class="e-content entry-content" itemprop="articleBody text">
    <div>
<p>Una historia de éxito: un grupito pequeño de programadores (o quizas sólo uno)
a pura pasión, café y feedback de sus usuarios mete miles de lineas de código
que logran hacer funcionar un negocio.</p>
<p>Parte del éxito, supongamos, es porque el sistema está hecho en Python, que se eligió porque es versátil y pragmático para obtener resultados rápidos.
Pero se sabe: en el vértigo la pasión, el feedback y el café no cabían muchas elegancias ni había tiempo para estilos o convenciones. <em>Caminante no hay camino, se hace camino al andar</em>, dijo Machado, refiriéndose a la deuda técnica que toman las startups en sus inicios.</p>
<p>El negocio comienza a crecer, hay más demandas de los clientes y la cosa está tan fea que algo, alguito, hay que mejorar. Como, por suerte, la cosa va bien, se contratan nuevos programadores que tengan experiencia en Python específicamente. Y estos nuevos programadores experimentados, los <em>pythonistas</em>, vienen con
sus mañosas convenciones del lenguaje a cuestas. Una de ellas está <a href="https://pep8.org#imports">tallada en piedra</a>: salvo ineludibles excepciones, <strong>los <em>imports</em> van en la cabecera del módulo y en un orden en particular</strong>.</p>
<p>Hay justificación, dicen los pythonistas. Simplificar la lectura, saber a simple vista de qué depende un módulo, tener bloques de código más chicos, no repetirse. Pero, aceptémoslo, es un <a href="https://es.wikipedia.org/wiki/Trastorno_obsesivo-compulsivo">TOC</a>.</p>
<!-- TEASER_END -->

<h4>
<code>move-imports</code>, un script para calmar el TOC de los <em>import</em> inlines</h4>
<p>La startup tiene cientos de módulos con imports en cualquier lado. Especialmente en los tests, donde existía una razón de fuerza mayor en el setup, cuyo <em>workaround</em> barato fue adoptar la convención <strong>tallada sobre diamante</strong> de que algunos tipos de imports (modelos de datos) debían hacerse adentro de la función de prueba.</p>
<p><em>"¡Vade retro Satana!"</em> se espantan entonces los pythonistas, encuentran el hueco para deshacerse de esa razón de fuerza mayor y se fabrican una herramienta (al que ponen el nada ingenioso nombre de "<a href="https://github.com/mgaitan/move-imports">move-imports</a>") para adaptar automáticamente los cientos de módulos a la convención. Porque somos vagos sólo para las cosas aburridas.</p>
<blockquote class="twitter-tweet">
<p lang="en" dir="ltr">being a programmer, I'm too lazy to spend 8 hours mindlessly performing a function, but not too lazy to spend 16 hours automating it.</p>— Martín Gaitán (@tin_nqn_) <a href="https://twitter.com/tin_nqn_/status/1253521851894181889?ref_src=twsrc%5Etfw">April 24, 2020</a>
</blockquote>

<p><script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script></p>
<p>Por ejemplo un módulo <code>path/to_refactor.py</code> con este contenido:</p>
<pre class="code literal-block"><span></span><code><span class="kn">from</span> <span class="nn">math</span> <span class="kn">import</span> <span class="n">sin</span>

<span class="k">def</span> <span class="nf">spam</span><span class="p">():</span>
    <span class="kn">from</span> <span class="nn">math</span> <span class="kn">import</span> <span class="n">cos</span>
    <span class="kn">import</span> <span class="nn">datetime</span> <span class="k">as</span> <span class="nn">dt</span>
    <span class="k">return</span> <span class="n">sin</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">cos</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">dt</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">ham</span><span class="p">():</span>
    <span class="kn">from</span> <span class="nn">math</span> <span class="kn">import</span> <span class="n">tan</span>
    <span class="k">return</span> <span class="n">tan</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</code></pre>


<p>se "refactoriza" con este comando</p>
<pre class="code literal-block"><span></span><code>$ move-imports path/to_refactor.py --isort
</code></pre>


<p>y queda así:</p>
<pre class="code literal-block"><span></span><code><span class="kn">import</span> <span class="nn">datetime</span> <span class="k">as</span> <span class="nn">dt</span>
<span class="kn">from</span> <span class="nn">math</span> <span class="kn">import</span> <span class="n">cos</span><span class="p">,</span> <span class="n">sin</span><span class="p">,</span> <span class="n">tan</span>


<span class="k">def</span> <span class="nf">spam</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">sin</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">cos</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">dt</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">ham</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">tan</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</code></pre>


<p>El <code>--isort</code> es opcional pero muy recomendado, ya que le pasa <a href="https://github.com/timothycrosley/isort">isort</a> para juntar imports del mismo módulo, quitar repetidos y ordenarlos como el Zen manda.</p>
<p>Un chichecito es que si encuentra que se puede marcar un import inline
con un comentario (por ejemplo <code># noqa</code>) en la misma linea o alguna linea arriba del import para ignorarlo de la lista de bloques a mover.</p>
<h4>¿Cómo funciona?</h4>
<p>El módulo <a href="https://docs.python.org/3/library/ast.html">ast</a> de la biblioteca estándar de Python es el que permite "parsear" el código fuente y obtener un árbol de objetos que representan la grámatica. Cada tipo de sentencia python es un nodo de este árbol, que puede a su vez tener sus propias nodos anidados.</p>
<p>Por ejemplo, el módulo <code>to_refactor.py</code> de arriba (en su versión original),
se ve así</p>
<pre class="code literal-block"><span></span><code><span class="n">In</span> <span class="p">[</span><span class="mi">4</span><span class="p">]:</span> <span class="n">mod</span> <span class="o">=</span>  <span class="n">ast</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="s1">'path/to_refactor.py'</span><span class="p">)</span><span class="o">.</span><span class="n">read_text</span><span class="p">())</span>
<span class="n">In</span> <span class="p">[</span><span class="mi">5</span><span class="p">]:</span> <span class="n">mod</span><span class="o">.</span><span class="n">body</span>
<span class="n">Out</span><span class="p">[</span><span class="mi">5</span><span class="p">]:</span>
<span class="p">[</span><span class="o">&lt;</span><span class="n">_ast</span><span class="o">.</span><span class="n">Import</span> <span class="n">at</span> <span class="mh">0x7f221c354eb8</span><span class="o">&gt;</span><span class="p">,</span>
 <span class="o">&lt;</span><span class="n">_ast</span><span class="o">.</span><span class="n">ImportFrom</span> <span class="n">at</span> <span class="mh">0x7f221c354898</span><span class="o">&gt;</span><span class="p">,</span>
 <span class="o">&lt;</span><span class="n">_ast</span><span class="o">.</span><span class="n">FunctionDef</span> <span class="n">at</span> <span class="mh">0x7f221c354c18</span><span class="o">&gt;</span><span class="p">,</span>
 <span class="o">&lt;</span><span class="n">_ast</span><span class="o">.</span><span class="n">FunctionDef</span> <span class="n">at</span> <span class="mh">0x7f221c33d240</span><span class="o">&gt;</span><span class="p">]</span>
</code></pre>


<p>A nosotros nos importa encontrar los nodos tipo <code>ast.Import</code> y <code>ast.ImportFrom</code> que son los que corresponden a sentencias <code>import x</code> y <code>from x import y</code>.</p>
<p>Podemos caminar todos los nodos recursivamente y obtener una gran lista plana
de todos los nodos con <code>ast.walk(mod)</code> donde <code>mod</code> es el nodo inicial, el módulo.</p>
<p>Un dato que incluye un nodo de <code>ast</code> es el número de línea donde esa sentencia comienza. Por ejemplo el <code>ImportFrom</code> de arriba</p>
<pre class="code literal-block"><span></span><code><span class="n">In</span> <span class="p">[</span><span class="mi">7</span><span class="p">]:</span> <span class="n">mod</span><span class="o">.</span><span class="n">body</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">lineno</span>
<span class="n">Out</span><span class="p">[</span><span class="mi">7</span><span class="p">]:</span> <span class="mi">2</span>
</code></pre>


<p>Podemos asumir que el bloque de líneas de código que componen un nodo termina justo antes de que empiece el que le sigue, así que es plausible una función que encuentre los segmentos (las lineas del source) donde hay <em>imports</em> y los recorte (es decir, reescriba el módulo sin esas lineas) y luego pegue todas las recortadas juntas justo a continuación de los imports que ya existen en la cabecera (o en la línea 1 si no había).</p>
<p>Si bien Python 3.8 trae una función llamada <a href="https://docs.python.org/3/library/ast.html#ast.get_source_segment">get_source_segment</a> que sería útil para este fin, hay dos motivos para hacerlo por nuestra cuenta:</p>
<ol>
<li>que funcione con otras versiones no tan nuevas de python</li>
<li>que no descarte comentarios que puedan estar justo arriba de un nodo a mover (por omisión, los comentarios no representan nodos en ast, así que hay que tratarlos desde la edición texto)</li>
</ol>
<p>Y eso es <a href="https://github.com/mgaitan/move-imports/blob/master/move_imports.py">casi todo</a>.</p>
<h4>Es parte del trabajo, amigos</h4>
<p>Las buenas startups (y las buenas personas que de alguna manera "cortan el queso" en ellas) comprenden que para mantener programadores y programadoras motivadas no se trata tanto de cervezas, festejos y merchandasing de regalo, sino de alimentar la creatividad y de dar cierta autonomía para que sean "quienes se embarran todos los días" quienes decidan cómo mejorar, y brindar los recursos para hacerlo.</p>
<p>A veces se puede más, a veces se puede menos, hay que saber adaptarse. Pero ayudar a solucionar esta picazones chiquitas (y mejor, haciendo algo que les puede servir a más personas, haciéndolo público) lleva tan solo algunas horas y repercute positivamente no sólo en el código, sino en el confort de un equipo y la motivación de las personas.</p>
<p>¡Por más horas de ñoñes rascándose picazones!</p>
</div>
    </div>
    <aside class="postpromonav"><nav><ul itemprop="keywords" class="tags">
<li><a class="tag p-category" href="../../categories/scripts/" rel="tag">scripts</a></li>
        </ul>
<ul class="pager hidden-print">
<li class="previous">
                <a href="../el-mono-salta-entre-las-ramas/" rel="prev" title="El mono salta entre las ramas. El desarrollador también">Post anterior</a>
            </li>
        </ul></nav></aside><section class="comments hidden-print"><h2>Comentarios</h2>
                        <div id="disqus_thread"></div>
        <script>
        var disqus_shortname ="nqnwebs",
            disqus_url="https://mgaitan.github.io/posts/move-imports-o-como-calmar-el-toc-de-un-pythonista/",
        disqus_title="move-imports, o c\u00f3mo calmar el TOC de un pythonista",
        disqus_identifier="cache/posts/move-imports-o-como-calmar-el-toc-de-un-pythonista.html",
        disqus_config = function () {
            this.language = "es_ES";
        };
        (function() {
            var dsq = document.createElement('script'); dsq.async = true;
            dsq.src = 'https://' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script><noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a>
</noscript>
    <a href="https://disqus.com" class="dsq-brlink" rel="nofollow">Comments powered by <span class="logo-disqus">Disqus</span></a>


        </section></article><script>var disqus_shortname="nqnwebs";(function(){var a=document.createElement("script");a.async=true;a.src="https://"+disqus_shortname+".disqus.com/count.js";(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(a)}());</script><!--End of body content--><footer id="footer">
            Contents © 2020         <a href="mailto:gaitan@gmail.com">Martín Gaitán</a> - Powered by         <a href="https://getnikola.com" rel="nofollow">Nikola</a>         
            
        </footer>
</div>
</div>

            <script src="../../assets/js/jquery.min.js"></script><script src="../../assets/js/popper.min.js"></script><script src="../../assets/js/bootstrap.min.js"></script><script src="../../assets/js/baguetteBox.min.js"></script><script>
    baguetteBox.run('div#content', {
        ignoreClass: 'islink',
        captions: function(element) {
            return element.getElementsByTagName('img')[0].alt;
    }});
    </script><script src="../../assets/js/jquery.timeago.js" type="text/javascript"></script><script>
    jQuery(document).ready(function() {

        if(jQuery('html').attr('lang') === 'es'){
             jQuery.timeago.settings.strings = {
               prefixAgo: "hace",
               prefixFromNow: "dentro de",
               suffixAgo: "",
               suffixFromNow: "",
               seconds: "menos de un minuto",
               minute: "un minuto",
               minutes: "unos %d minutos",
               hour: "una hora",
               hours: "%d horas",
               day: "un día",
               days: "%d días",
               month: "un mes",
               months: "%d meses",
               year: "un año",
               years: "%d años"
            };
        }
        jQuery("time.published").timeago();

        jQuery('article:not(:first)').before('<hr>');

        jQuery('.highlight pre').addClass('code');
    });
    </script><script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-51074482-1', 'mgaitan.github.io');
      ga('send', 'pageview');

    </script>
</body>
</html>
